<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Imagens de Produtos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .product {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .photo {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 1px solid #ccc;
            margin: 5px;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .info {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #0056b3;
        }
        .url-display {
            font-family: monospace;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 3px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>Teste de Imagens de Produtos</h1>
    
    <div>
        <label>API URL: 
            <input type="text" id="apiUrl" value="http://localhost:3000" style="width: 300px;">
        </label>
        <br><br>
        <label>Token de Autentica√ß√£o: 
            <input type="text" id="token" value="" style="width: 500px;" placeholder="Cole o token JWT aqui">
        </label>
        <br><br>
        <button onclick="testProducts()">Testar Produtos</button>
        <button onclick="testSingleImage()">Testar Imagem √önica</button>
        <button onclick="clearResults()">Limpar</button>
    </div>

    <div id="results"></div>

    <script>
        function getImageUrl(url, baseUrl) {
            if (!url) return '';
            
            // Se j√° √© uma URL completa, usar como est√°
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url;
            }
            
            // Se √© um caminho relativo, construir URL completa
            return `${baseUrl}${url.startsWith('/') ? '' : '/'}${url}`;
        }

        async function testProducts() {
            const apiUrl = document.getElementById('apiUrl').value;
            const token = document.getElementById('token').value;
            const resultsDiv = document.getElementById('results');
            
            if (!token) {
                resultsDiv.innerHTML = '<div class="error">Por favor, cole o token de autentica√ß√£o</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="info">Carregando produtos...</div>';

            try {
                const response = await fetch(`${apiUrl}/product?page=1&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Resposta da API:', data);

                let html = `<h2>Resultado:</h2>`;
                html += `<div class="info">Total de produtos: ${data.products.length}</div>`;

                if (data.products.length === 0) {
                    html += '<div class="error">Nenhum produto encontrado</div>';
                } else {
                    data.products.forEach((product, index) => {
                        html += `<div class="product">`;
                        html += `<h3>${index + 1}. ${product.name}</h3>`;
                        html += `<p><strong>ID:</strong> ${product.id}</p>`;
                        html += `<p><strong>Barcode:</strong> ${product.barcode}</p>`;
                        html += `<p><strong>Pre√ßo:</strong> R$ ${product.price}</p>`;
                        html += `<p><strong>Photos (raw):</strong> ${JSON.stringify(product.photos)}</p>`;
                        html += `<p><strong>Type:</strong> ${typeof product.photos} | <strong>Array:</strong> ${Array.isArray(product.photos)}</p>`;
                        
                        if (product.photos && Array.isArray(product.photos) && product.photos.length > 0) {
                            html += `<div><strong>Fotos (${product.photos.length}):</strong></div>`;
                            product.photos.forEach((photoUrl, photoIndex) => {
                                const fullUrl = getImageUrl(photoUrl, apiUrl);
                                html += `<div style="margin: 10px 0;">`;
                                html += `<p><strong>Foto ${photoIndex + 1}:</strong></p>`;
                                html += `<p class="url-display"><strong>Original:</strong> ${photoUrl}</p>`;
                                html += `<p class="url-display"><strong>Full URL:</strong> ${fullUrl}</p>`;
                                html += `<img src="${fullUrl}" class="photo" 
                                    onerror="this.style.border='2px solid red'; this.alt='ERRO ao carregar'" 
                                    onload="this.style.border='2px solid green'"
                                    alt="Foto ${photoIndex + 1}">`;
                                html += `</div>`;
                            });
                        } else {
                            html += `<div class="error">Nenhuma foto dispon√≠vel</div>`;
                        }
                        
                        html += `</div>`;
                    });
                }

                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('Erro:', error);
                resultsDiv.innerHTML = `<div class="error">Erro: ${error.message}</div>`;
            }
        }

        async function testSingleImage() {
            const apiUrl = document.getElementById('apiUrl').value;
            const testUrl = prompt('Cole a URL da imagem para testar (ex: /uploads/products/123/image.jpg):');
            
            if (!testUrl) return;

            const fullUrl = getImageUrl(testUrl, apiUrl);
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="info">
                    <h2>Teste de Imagem √önica</h2>
                    <p><strong>URL Original:</strong> <span class="url-display">${testUrl}</span></p>
                    <p><strong>URL Completa:</strong> <span class="url-display">${fullUrl}</span></p>
                    <p><strong>Status:</strong> <span id="imageStatus">Carregando...</span></p>
                    <img src="${fullUrl}" class="photo" 
                        onerror="document.getElementById('imageStatus').innerHTML='<span class=error>ERRO ao carregar</span>'; this.style.border='2px solid red';" 
                        onload="document.getElementById('imageStatus').innerHTML='<span class=success>Carregada com sucesso!</span>'; this.style.border='2px solid green';"
                        alt="Teste">
                </div>
            `;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Instru√ß√µes iniciais
        window.onload = () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="info">
                    <h3>üìù Instru√ß√µes:</h3>
                    <ol>
                        <li>Certifique-se de que o backend est√° rodando (porta 3000)</li>
                        <li>Fa√ßa login no sistema e copie o token JWT do localStorage:
                            <pre>localStorage.getItem('token')</pre>
                        </li>
                        <li>Cole o token no campo acima</li>
                        <li>Clique em "Testar Produtos" para ver todos os produtos</li>
                        <li>Verifique se as imagens carregam (borda verde = sucesso, vermelha = erro)</li>
                    </ol>
                </div>
            `;
        };
    </script>
</body>
</html>

